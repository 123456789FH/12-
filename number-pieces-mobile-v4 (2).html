<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù‚Ø·Ø¹ Ø§Ù„Ø¹Ø¯ â€” Ù…ÙƒØ¹Ø¨ Ø§Ù„Ø£Ù„Ù + Ù‚Ù„Ù… (Bottom Sheet + Header Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ)</title>
<style>
  :root{
    --bg: #fff7fb;
    --ink:#222;
    --muted:#6b7280;
    --ring:#a78bfa;
    --one:#10b981;
    --ten:#0ea5e9;
    --hund:#f59e0b;
    --thou:#8b5cf6;
    --grid:#e5e7eb;
    --panel:#ffffff;
    --shadow:0 12px 28px rgba(0,0,0,.08);
    --radius:18px;
    --cell:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic", "Noto Sans Arabic", Tahoma, Arial, sans-serif;
    color:var(--ink);
    background:
      radial-gradient(1000px 500px at 120% -20%, #ffe4f0 20%, transparent 60%),
      radial-gradient(1200px 600px at -20% 120%, #e8f5ff 20%, transparent 60%),
      var(--bg);
    overscroll-behavior-y: none;
  }
  header{
    position:sticky; top:0; z-index:200; background:rgba(255,255,255,.85); backdrop-filter:saturate(180%) blur(10px);
    border-bottom:1px solid #f0f0f0; transition: transform .25s ease;
  }
  header.collapsed{ transform: translateY(-100%); }
  #btnShowHeader{
    position:fixed; top:8px; inset-inline-start:8px; z-index:210;
    display:none; border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:8px 12px; font-weight:700; box-shadow:var(--shadow);
  }
  header.collapsed + #btnShowHeader{ display:inline-flex; }

  .wrap{max-width:1200px;margin:0 auto;padding:10px 12px}
  .topbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .title{display:flex;align-items:center;gap:8px;margin-inline-end:auto}
  .title h1{margin:0;font-size:16px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
  .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);
       display:inline-flex;align-items:center;gap:8px}
  .btn.min{padding:6px 10px;border-radius:10px}
  .btn:focus{outline:3px solid var(--ring);outline-offset:2px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;box-shadow:var(--shadow);}

  main{max-width:1200px;margin:12px auto;display:grid;grid-template-columns: 300px 1fr;gap:12px;padding:0 12px}
  @media (max-width: 960px){ main{grid-template-columns:1fr;} .panel{display:none} .panel.force{display:block} }
  .panel{background:var(--panel);border:1px solid #f1f1f1;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .panel h2{margin:0 0 8px;font-size:16px}
  .panel .sec{margin-top:12px}
  .panel code{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:2px 6px}

  .workspace{
    position:relative;
    min-height: calc(100svh - 200px);
    border:1px dashed #e5e7eb;border-radius:var(--radius);box-shadow:var(--shadow);background:#fff;overflow:hidden;
    touch-action: none; overscroll-behavior: contain; -webkit-user-select:none; user-select:none;
  }
  .grid-on{background-image: linear-gradient(0deg, transparent calc(var(--cell) - 1px), var(--grid) calc(var(--cell) - 1px)),
                               linear-gradient(90deg, transparent calc(var(--cell) - 1px), var(--grid) calc(var(--cell) - 1px));
            background-size: var(--cell) var(--cell);}

  .piece{
    position:absolute; cursor:grab; transform-origin: top left; will-change:left, top, transform;
    pointer-events:auto; contain:layout paint;
    touch-action:none; -webkit-user-drag:none; -webkit-tap-highlight-color: transparent;
  }
  .piece *{pointer-events:none}
  .piece.dragging{cursor:grabbing;opacity:.97}
  .piece.selected{outline:3px dashed var(--ring); outline-offset:2px}
  .piece .lbl{position:absolute;bottom:-22px;left:0;right:0;text-align:center;font:700 12px/1 system-ui;color:#111}

  .unit{width:var(--cell);height:var(--cell);border:2px solid var(--one);background:rgba(16,185,129,.15); border-radius:4px}
  .rod{height:var(--cell); width:calc(var(--cell) * 10);
       background: repeating-linear-gradient(90deg, rgba(14,165,233,.18) 0, rgba(14,165,233,.18) var(--cell), transparent var(--cell), transparent calc(var(--cell) + 1px));
       border:2px solid var(--ten); border-radius:8px}
  .flat{width:calc(var(--cell) * 10); height:calc(var(--cell) * 10);
        background:
          linear-gradient(#0000, #0000),
          repeating-linear-gradient(0deg, rgba(245,158,11,.16) 0, rgba(245,158,11,.16) var(--cell), transparent var(--cell), transparent calc(var(--cell) + 1px)),
          repeating-linear-gradient(90deg, rgba(245,158,11,.16) 0, rgba(245,158,11,.16) var(--cell), transparent var(--cell), transparent calc(var(--cell) + 1px));
        border:2px solid var(--hund); border-radius:10px}

  .cube{width:144px;height:120px;position:absolute}
  .cube svg{display:block}
  .cube .lbl-in{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;color:#3b0764;mix-blend-mode:multiply}

  /* Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‚Ù„Ù… */
  #inkCanvas{position:absolute; inset:0; width:100%; height:100%; pointer-events:none; touch-action:none;}
  .drawing #inkCanvas{pointer-events:auto; cursor:crosshair;}
  .tool-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .range{accent-color: var(--ring);}

  .muted{color:var(--muted)}
  .kbd{font:700 12px/1.2 ui-monospace; background:#f3f4f6; border:1px solid #e5e7eb; padding:2px 6px; border-radius:6px}
  .footer{margin-top:12px;font-size:12px;color:#555}

  /* Bottom Sheet */
  .sheet{ position:fixed; inset:0; display:none; z-index:300; }
  .sheet.open{ display:block; }
  .sheet .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
  .sheet .panel{
    position:absolute; inset-inline:0; bottom:0; background:#fff; border-radius:18px 18px 0 0; border:1px solid #eee;
    box-shadow: 0 -16px 40px rgba(0,0,0,.15); padding:12px; transform: translateY(100%); transition: transform .25s ease;
  }
  .sheet.open .panel{ transform: translateY(0); }
  .handle{ width:48px; height:5px; background:#e5e7eb; border-radius:999px; margin:6px auto 10px; }
  .sheet h3{margin:0 0 8px; font-size:14px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .item{display:inline-flex; align-items:center; gap:8px; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff; cursor:pointer; font-weight:700; justify-content:center}
  .row{display:flex; gap:8px; flex-wrap:wrap;}

  /* Ø´Ø±ÙŠØ· Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ø¦Ù… */
  #miniStats{
    position:fixed; bottom:12px; inset-inline-start:12px; z-index:220;
    background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:6px 10px; font:700 12px/1.2 system-ui; box-shadow:var(--shadow);
  }
</style>
</head>
<body>
  <header id="header">
    <div class="wrap">
      <div class="topbar">
        <div class="title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden>
            <rect x="3" y="3" width="6" height="6" rx="1.5" fill="var(--one)"/>
            <rect x="11" y="3" width="10" height="6" rx="1.5" fill="var(--ten)"/>
            <rect x="3" y="11" width="10" height="10" rx="2" fill="var(--hund)"/>
            <rect x="15" y="11" width="6" height="6" rx="1.5" fill="var(--thou)"/>
          </svg>
          <h1>Ù‚Ø·Ø¹ Ø§Ù„Ø¹Ø¯ â€” Ù†Ø³Ø®Ø© Bottom Sheet</h1>
        </div>
        <button class="btn" id="openAddSheet">ï¼‹ Ø¥Ø¶Ø§ÙØ©</button>
        <button class="btn min" id="btnPenTop">âœ Ø§Ù„Ù‚Ù„Ù…</button>
        <button class="btn min" id="openMoreSheet">â‹¯ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
        <button class="btn min" id="btnCollapse">â¬†ï¸ Ø·ÙŠ Ø§Ù„Ø´Ø±ÙŠØ·</button>
      </div>
    </div>
  </header>
  <button id="btnShowHeader">â¬‡ï¸ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ·</button>

  <main>
    <aside class="panel" id="panel">
      <h2>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©</h2>
      <div id="counts">â€”</div>

      <div class="sec">
        <h3 style="margin:0 0 6px">Ù‚Ù„Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø©</h3>
        <div class="tool-row">
          <button class="btn min" id="btnPen">âœ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ù„Ù…</button>
          <button class="btn min" id="btnEraser">Ù…Ù…Ø­Ø§Ø©</button>
          <label>Ø§Ù„Ø³ÙÙ…Ùƒ <input id="size" class="range" type="range" min="2" max="24" step="1" value="8" style="vertical-align:middle"></label>
        </div>
        <div class="tool-row" id="palette" aria-label="Ø£Ù„ÙˆØ§Ù†">
          <button class="btn min" data-col="#111" style="background:#111;color:#fff">Ø£Ø³ÙˆØ¯</button>
          <button class="btn min" data-col="#1f2937" style="background:#1f2937;color:#fff">Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚</button>
          <button class="btn min" data-col="#ef4444" style="background:#ef4444;color:#fff">Ø£Ø­Ù…Ø±</button>
          <button class="btn min" data-col="#0ea5e9" style="background:#0ea5e9;color:#fff">Ø£Ø²Ø±Ù‚</button>
          <button class="btn min" data-col="#10b981" style="background:#10b981;color:#fff">Ø£Ø®Ø¶Ø±</button>
          <button class="btn min" data-col="#f59e0b" style="background:#f59e0b;color:#fff">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</button>
          <button class="btn min" data-col="#8b5cf6" style="background:#8b5cf6;color:#fff">Ø¨Ù†ÙØ³Ø¬ÙŠ</button>
        </div>
        <div class="tool-row" style="margin-top:8px">
          <button class="btn min" id="btnUndo" title="ØªØ±Ø§Ø¬Ø¹">â†¶ ØªØ±Ø§Ø¬Ø¹</button>
          <button class="btn min" id="btnRedo" title="Ø¥Ø¹Ø§Ø¯Ø©">â†· Ø¥Ø¹Ø§Ø¯Ø©</button>
          <button class="btn min" id="btnClearInk" title="Ù…Ø³Ø­">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ù…Ø©</button>
        </div>
        <p class="muted" style="margin:8px 0 0">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø±Ø³Ù… Ù„Ø§ ÙŠØ­Ø±Ù‘ÙƒØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„.</p>
      </div>

      <div class="sec">
        <details>
          <summary>Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ù„ÙˆÙ†ÙŠ Ù„Ù„Ù‚Ø·Ø¹</summary>
          <ul><li>ÙˆØ§Ø­Ø¯ = 1</li><li>Ø¹Ø´Ø±Ø© = 10</li><li>Ù…Ø¦Ø© = 100</li><li>Ø£Ù„Ù = 1000</li></ul>
        </details>
      </div>

      <div class="footer">Ø¨Ø±Ù…Ø¬Ø© Ø§ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
    </aside>

    <section id="workspace" class="workspace grid-on" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…Ù„">
      <canvas id="inkCanvas"></canvas>
    </section>
  </main>

  <!-- Mini Stats -->
  <div id="miniStats" aria-live="polite">Ù…Ø¬Ù…ÙˆØ¹: 0</div>

  <!-- Add Sheet -->
  <div class="sheet" id="sheetAdd" aria-hidden="true">
    <div class="backdrop" data-close="sheetAdd"></div>
    <div class="panel" role="dialog" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¶Ø§ÙØ©">
      <div class="handle"></div>
      <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹</h3>
      <div class="grid">
        <button class="item" data-add="one">ÙˆØ§Ø­Ø¯</button>
        <button class="item" data-add="ten">Ø¹Ø´Ø±Ø©</button>
        <button class="item" data-add="hundred">Ù…Ø¦Ø©</button>
        <button class="item" data-add="thousand">Ø£Ù„Ù</button>
      </div>
    </div>
  </div>

  <!-- More Sheet -->
  <div class="sheet" id="sheetMore" aria-hidden="true">
    <div class="backdrop" data-close="sheetMore"></div>
    <div class="panel" role="dialog" aria-label="Ø§Ù„Ù…Ø²ÙŠØ¯">
      <div class="handle"></div>
      <h3>Ø§Ù„Ù…Ø²ÙŠØ¯</h3>
      <div class="grid">
        <button class="item" id="btnRotate">âŸ³ ØªØ¯ÙˆÙŠØ±</button>
        <button class="item" id="btnDuplicate">â˜ Ù†Ø³Ø®</button>
        <button class="item" id="btnDelete">ğŸ—‘ Ø­Ø°Ù</button>
        <button class="item" id="btnExplode">â§‰ ØªÙÙƒÙŠÙƒ</button>
        <button class="item" id="btnReset">â†º Ø¥Ø¹Ø§Ø¯Ø©</button>
        <label class="item" style="justify-content:space-between">
          <span>Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„Ø´Ø¨ÙƒØ©</span>
          <input type="checkbox" id="snap" checked>
        </label>
        <button class="item" id="btnExport">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
        <button class="item" id="btnImport">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        <button class="item" id="btnTogglePanel">ğŸ§° Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ù„Ù…</button>
        <button class="item" id="btnFocus">ğŸ§¿ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const header = document.getElementById('header');
  const btnCollapse = document.getElementById('btnCollapse');
  const btnShowHeader = document.getElementById('btnShowHeader');
  btnCollapse.addEventListener('click', ()=> header.classList.add('collapsed'));
  btnShowHeader.addEventListener('click', ()=> header.classList.remove('collapsed'));

  function openSheet(id){
    const sh = document.getElementById(id);
    sh.classList.add('open'); sh.setAttribute('aria-hidden','false');
  }
  function closeSheet(id){
    const sh = document.getElementById(id);
    sh.classList.remove('open'); sh.setAttribute('aria-hidden','true');
  }

  // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙŠØª
  document.getElementById('openAddSheet').addEventListener('click', ()=> openSheet('sheetAdd'));
  document.getElementById('openMoreSheet').addEventListener('click', ()=> openSheet('sheetMore'));
  document.querySelectorAll('.sheet .backdrop').forEach(el=>{
    el.addEventListener('click', (e)=> closeSheet(e.target.getAttribute('data-close')));
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ø¨Ø± Ø³Ø­Ø¨ Ù„Ø£Ø³ÙÙ„
  document.querySelectorAll('.sheet .panel').forEach(panel=>{
    let startY=0, dy=0;
    panel.addEventListener('touchstart', (e)=>{ startY = e.touches[0].clientY; dy=0; }, {passive:true});
    panel.addEventListener('touchmove', (e)=>{
      dy = e.touches[0].clientY - startY;
      if(dy>0){ panel.style.transform = `translateY(${dy}px)`; }
    }, {passive:true});
    panel.addEventListener('touchend', ()=>{
      const id = panel.parentElement.id;
      if(dy>80){ closeSheet(id); }
      panel.style.transform = '';
    });
  });

  const WS = document.getElementById('workspace');
  const INK = document.getElementById('inkCanvas');
  const panel = document.getElementById('panel');
  const snapToggle = document.getElementById('snap');
  const countsDiv = document.getElementById('counts');
  const mini = document.getElementById('miniStats');
  const btnPenTop = document.getElementById('btnPenTop');
  const CELL = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell')) || 12;
  const dpr = Math.max(1, window.devicePixelRatio || 1);

  function lockScroll(on){ /* no-op to avoid jumps on iOS */ }

  /* Ù‚Ù„Ù… */
  let DRAW_MODE = false;
  let ERASER = false;
  let color = '#111';
  let size = 8;
  let paths = [];
  let redoStack = [];
  let activePath = null;
  let ctx = null;

  function setupCanvas(){
    const rect = WS.getBoundingClientRect();
    const w = Math.floor(rect.width);
    const h = Math.floor(rect.height);
    INK.width = Math.floor(w * dpr);
    INK.height = Math.floor(h * dpr);
    INK.style.width = w + 'px';
    INK.style.height = h + 'px';
    ctx = INK.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    renderAllPaths();
  }

  function renderAllPaths(){
    if(!ctx) return;
    const rect = WS.getBoundingClientRect();
    ctx.clearRect(0, 0, rect.width, rect.height);
    for(const p of paths){
      ctx.save();
      ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = p.size;
      if(p.erase){ ctx.globalCompositeOperation = 'destination-out'; ctx.strokeStyle = 'rgba(0,0,0,1)'; }
      else { ctx.globalCompositeOperation = 'source-over'; ctx.strokeStyle = p.color; }
      ctx.beginPath();
      for(let i=0;i<p.points.length;i++){
        const pt = p.points[i];
        if(i===0) ctx.moveTo(pt.x, pt.y); else ctx.lineTo(pt.x, pt.y);
      }
      ctx.stroke();
      ctx.restore();
    }
  }

  function startPath(x, y){ activePath = {points:[{x,y}], color, size, erase:ERASER}; paths.push(activePath); redoStack.length = 0; }
  function addPoint(x,y){ if(!activePath) return; activePath.points.push({x,y}); renderAllPaths(); }
  function endPath(){ activePath = null; }
  function posFromEvent(e){ const r = INK.getBoundingClientRect(); return {x: e.clientX - r.left, y: e.clientY - r.top}; }

  const btnPen = document.getElementById('btnPen');
  const btnEraser = document.getElementById('btnEraser');
  const btnUndo = document.getElementById('btnUndo');
  const btnRedo = document.getElementById('btnRedo');
  const btnClearInk = document.getElementById('btnClearInk');
  const sizeInput = document.getElementById('size');
  function syncPenButtons(){
    const on = DRAW_MODE;
    const txt = on ? 'âœ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚Ù„Ù…' : 'âœ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ù„Ù…';
    if(btnPen) btnPen.textContent = txt;
    if(btnPenTop) btnPenTop.textContent = on ? 'âœ Ø§Ù„Ù‚Ù„Ù… (Ù…ÙØ¹Ù„)' : 'âœ Ø§Ù„Ù‚Ù„Ù…';
    WS.classList.toggle('drawing', on);
  }
  function togglePen(){ DRAW_MODE = !DRAW_MODE; ERASER = false; syncPenButtons(); }
  if(btnPen) btnPen.addEventListener('click', togglePen);
  if(btnPenTop) btnPenTop.addEventListener('click', togglePen);
  if(btnEraser) btnEraser.addEventListener('click', ()=>{ if(!DRAW_MODE){ DRAW_MODE = true; } ERASER = !ERASER; syncPenButtons(); if(btnEraser) btnEraser.textContent = ERASER ? 'ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø³Ù…' : 'Ù…Ù…Ø­Ø§Ø©'; });
  if(sizeInput) sizeInput.addEventListener('input', ()=> size = parseInt(sizeInput.value,10)||8);
  const palette = document.getElementById('palette');
  if(palette) palette.addEventListener('click', (e)=>{ const col = e.target.getAttribute('data-col'); if(!col) return; color = col; ERASER = false; if(btnEraser) btnEraser.textContent = 'Ù…Ù…Ø­Ø§Ø©'; });
  if(btnUndo) btnUndo.addEventListener('click', ()=>{ if(paths.length){ redoStack.push(paths.pop()); renderAllPaths(); }});
  if(btnRedo) btnRedo.addEventListener('click', ()=>{ if(redoStack.length){ paths.push(redoStack.pop()); renderAllPaths(); }});
  if(btnClearInk) btnClearInk.addEventListener('click', ()=>{ paths.length=0; redoStack.length=0; renderAllPaths(); });

  INK.addEventListener('pointerdown', (e)=>{ if(!DRAW_MODE) return; e.preventDefault(); const p = posFromEvent(e); startPath(p.x, p.y); try{ INK.setPointerCapture(e.pointerId); }catch(_){}});
  INK.addEventListener('pointermove', (e)=>{ if(!DRAW_MODE || !activePath) return; e.preventDefault(); const p = posFromEvent(e); addPoint(p.x, p.y); });
  INK.addEventListener('pointerup', ()=>{ if(!DRAW_MODE) return; endPath(); });
  INK.addEventListener('pointercancel', ()=>{ if(!DRAW_MODE) return; endPath(); });
  INK.addEventListener('touchmove', (e)=>{ if(DRAW_MODE) e.preventDefault(); }, {passive:false});

  // Ù‚Ø·Ø¹ Ø§Ù„Ø¹Ø¯
  const PIECE_INFO = {
    one:      { value:1,    class:'unit',   name:'ÙˆØ§Ø­Ø¯' },
    ten:      { value:10,   class:'rod',    name:'Ø¹Ø´Ø±Ø©' },
    hundred:  { value:100,  class:'flat',   name:'Ù…Ø¦Ø©' },
    thousand: { value:1000, class:'cube',   name:'Ø£Ù„Ù' }
  };
  let z = 1, selected = null, dragging = null, dragOffX = 0, dragOffY = 0, moved = false;

  function createPiece(type, x=24, y=24, rot=0){
    const info = PIECE_INFO[type];
    const el = document.createElement('div');
    el.className = `piece ${info.class}`;
    el.dataset.type = type; el.dataset.value = info.value; el.dataset.rot = rot;
    el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.zIndex = ++z;

    if(type === 'thousand'){
      el.innerHTML = cubeSVG();
      const label = document.createElement('div'); label.className = 'lbl-in'; label.textContent = '1000'; el.appendChild(label);
    } else {
      const lab = document.createElement('div'); lab.className = 'lbl'; lab.textContent = `${info.name} (=${info.value})`; el.appendChild(lab);
    }
    if(rot) applyRotation(el, rot);
    WS.appendChild(el); wirePiece(el); updateCounts(); return el;
  }

  function cubeSVG(){
    return `<svg width="144" height="120" viewBox="0 0 144 120" xmlns="http://www.w3.org/2000/svg" aria-hidden>
      <defs>
        <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#ede9fe"/><stop offset="1" stop-color="#c4b5fd"/>
        </linearGradient>
        <linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#ddd6fe"/><stop offset="1" stop-color="#a78bfa"/>
        </linearGradient>
        <linearGradient id="g3" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#cabffd"/><stop offset="1" stop-color="#8b5cf6"/>
        </linearGradient>
      </defs>
      <polygon points="72,6 132,36 72,66 12,36" fill="url(#g1)" stroke="#7c3aed" stroke-width="1.5"/>
      <polygon points="132,36 132,90 72,120 72,66" fill="url(#g2)" stroke="#7c3aed" stroke-width="1.5"/>
      <polygon points="12,36 12,90 72,120 72,66" fill="url(#g3)" stroke="#7c3aed" stroke-width="1.5"/>
    </svg>`;
  }

  function wirePiece(el){
    el.addEventListener('pointerdown', onDown, {passive:false});
    el.addEventListener('click', ()=> select(el));
    el.addEventListener('dblclick', ()=> { if(!dragging && !moved && !DRAW_MODE) explode(el); });
  }

  function onDown(e){
    if(DRAW_MODE) return;
    if(!(e.currentTarget.classList.contains('piece'))) return;
    e.preventDefault();
    const el = e.currentTarget;
    select(el); dragging = el; moved = false;
    el.classList.add('dragging');
    const rect = el.getBoundingClientRect();
    dragOffX = e.clientX - rect.left; dragOffY = e.clientY - rect.top;
    try { el.setPointerCapture(e.pointerId); } catch(_) {}
    const move = (ev)=> onMove(ev);
    const up = (ev)=>{ onUp(ev); el.removeEventListener('pointermove', move); el.removeEventListener('pointerup', up); el.removeEventListener('pointercancel', up); };
    el.addEventListener('pointermove', move); el.addEventListener('pointerup', up); el.addEventListener('pointercancel', up);
  }

  function onMove(e){
    if(!dragging) return;
    e.preventDefault();
    moved = true;
    const wsRect = WS.getBoundingClientRect();
    let x = e.clientX - wsRect.left - dragOffX;
    let y = e.clientY - wsRect.top - dragOffY;
    x = Math.max(0, Math.min(x, WS.clientWidth - dragging.offsetWidth));
    y = Math.max(0, Math.min(y, WS.clientHeight - dragging.offsetHeight));
    dragging.style.left = x + 'px'; dragging.style.top = y + 'px';
  }

  function onUp(e){
    if(!dragging) return;
    const el = dragging;
    el.classList.remove('dragging');
    try { el.releasePointerCapture && el.releasePointerCapture(e.pointerId); } catch(_) {}
    if(snapToggle && snapToggle.checked) snapToGrid(el);
    dragging = null;
  }

  WS.addEventListener('touchmove', (e)=>{ if(dragging) e.preventDefault(); }, {passive:false});

  function snapToGrid(el){
    let x = Math.round(parseInt(el.style.left)/CELL)*CELL;
    let y = Math.round(parseInt(el.style.top)/CELL)*CELL;
    x = Math.max(0, Math.min(x, WS.clientWidth - el.offsetWidth));
    y = Math.max(0, Math.min(y, WS.clientHeight - el.offsetHeight));
    el.style.left = x + 'px'; el.style.top = y + 'px';
  }

  function select(el){ if(selected) selected.classList.remove('selected'); selected = el; if(el) el.classList.add('selected'); if(el) el.style.zIndex = ++z; }
  function rotate(el){ if(!el) return; const type = el.dataset.type; if(type === 'ten' || type === 'hundred'){ const rot = ((parseInt(el.dataset.rot)||0) + 90) % 180; applyRotation(el, rot);} }
  function applyRotation(el, rot){ el.dataset.rot = rot; el.style.transform = `rotate(${rot}deg)`; }
  function duplicate(el){ if(!el) return; const type = el.dataset.type; const x = Math.min(parseInt(el.style.left) + 16, WS.clientWidth - el.offsetWidth); const y = Math.min(parseInt(el.style.top) + 16, WS.clientHeight - el.offsetHeight); const rot = parseInt(el.dataset.rot)||0; const copy = createPiece(type, x, y, rot); select(copy); }
  function remove(el){ if(!el) return; el.remove(); selected=null; updateCounts(); }
  function explode(el){
    if(!el) return;
    const map = { thousand:'hundred', hundred:'ten', ten:'one' };
    const type = el.dataset.type; const child = map[type];
    if(!child) return;
    const baseX = parseInt(el.style.left); const baseY = parseInt(el.style.top);
    const positions = gridPositionsFor(child, baseX, baseY);
    remove(el); positions.forEach((p)=> createPiece(child, p.x, p.y));
  }
  function gridPositionsFor(type, baseX, baseY){
    const arr = [];
    if(type==='one'){ for(let r=0;r<2;r++) for(let c=0;c<5;c++) arr.push({x: baseX + c*CELL, y: baseY + r*CELL}); }
    else if(type==='ten'){
      const w = CELL*10; const h = CELL;
      for(let i=0;i<10;i++) arr.push({x: baseX + (i%5)*(w+4), y: baseY + Math.floor(i/5)*(h+10)});
    } else if(type==='hundred'){
      const s = CELL*10;
      for(let i=0;i<10;i++) arr.push({x: baseX + (i%5)*(s+8), y: baseY + Math.floor(i/5)*(s+8)});
    }
    return arr.map(p=>({x: Math.max(0, Math.min(p.x, WS.clientWidth-160)), y: Math.max(0, Math.min(p.y, WS.clientHeight-160))}));
  }

  function updateCounts(){
    const nodes = [...WS.querySelectorAll('.piece')];
    const sum = nodes.reduce((s,n)=> s + (parseInt(n.dataset.value)||0), 0);
    const byType = {one:0,ten:0,hundred:0,thousand:0};
    nodes.forEach(n=> byType[n.dataset.type]++ );
    const K = Math.floor(sum/1000);
    const H = Math.floor((sum%1000)/100);
    const T = Math.floor((sum%100)/10);
    const O = sum%10;

    countsDiv.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹:</div>
        <div>Ø¢Ø­Ø§Ø¯: <b>${byType.one}</b> â€¢ Ø¹Ø´Ø±Ø§Øª: <b>${byType.ten}</b> â€¢ Ù…Ø¦Ø§Øª: <b>${byType.hundred}</b> â€¢ Ø¢Ù„Ø§Ù: <b>${byType.thousand}</b></div>
        <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</div>
        <div style="font-weight:800">${sum}</div>
        <div>ØªÙØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</div>
        <div><b>${K}</b> Ø£Ù„Ù â€¢ <b>${H}</b> Ù…Ø¦Ø© â€¢ <b>${T}</b> Ø¹Ø´Ø±Ø© â€¢ <b>${O}</b> ÙˆØ§Ø­Ø¯</div>
      </div>`;
    mini.textContent = `Ù…Ø¬Ù…ÙˆØ¹: ${sum} â€” Ø¢Ø­Ø§Ø¯:${byType.one} Ø¹Ø´Ø±Ø§Øª:${byType.ten} Ù…Ø¦Ø§Øª:${byType.hundred} Ø¢Ù„Ø§Ù:${byType.thousand}`;
  }

  // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´ÙŠØª
  document.getElementById('sheetAdd').addEventListener('click', (e)=>{
    const t = e.target.closest('[data-add]'); if(!t) return;
    const type = t.getAttribute('data-add');
    const x = 24 + Math.random()*60; const y = 24 + Math.random()*60;
    const el = createPiece(type, x, y); if(snapToggle && snapToggle.checked) snapToGrid(el); select(el);
    closeSheet('sheetAdd');
  });

  document.getElementById('btnRotate').addEventListener('click', ()=> rotate(selected));
  document.getElementById('btnDuplicate').addEventListener('click', ()=> duplicate(selected));
  document.getElementById('btnDelete').addEventListener('click', ()=> remove(selected));
  document.getElementById('btnExplode').addEventListener('click', ()=> explode(selected));
  document.getElementById('btnReset').addEventListener('click', ()=> { WS.innerHTML=''; WS.appendChild(INK); selected=null; updateCounts(); renderAllPaths(); });
  document.getElementById('btnExport').addEventListener('click', ()=>{
    const pieces = [...WS.querySelectorAll('.piece')].map(n=>({
      type:n.dataset.type,
      x:parseInt(n.style.left), y:parseInt(n.style.top), rot:parseInt(n.dataset.rot)||0
    }));
    const blob = new Blob([JSON.stringify({v:6, pieces, ink: paths}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'number-pieces-mobile.json'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('btnImport').addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = () => {
      const file = inp.files[0]; if(!file) return;
      file.text().then(txt=>{
        try{
          const obj = JSON.parse(txt); WS.innerHTML=''; WS.appendChild(INK); selected=null;
          (obj.pieces || obj.data || []).forEach(p=> createPiece(p.type, p.x, p.y, p.rot||0));
          paths = obj.ink || []; redoStack = []; renderAllPaths();
          updateCounts();
        }catch(e){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
      });
    };
    inp.click();
  });
  document.getElementById('btnTogglePanel').addEventListener('click', ()=>{
    panel.classList.toggle('force'); closeSheet('sheetMore');
  });
  document.getElementById('btnFocus').addEventListener('click', ()=>{
    header.classList.add('collapsed'); panel.classList.remove('force'); closeSheet('sheetMore');
  });

  // Ø§Ù„Ø´Ø¨ÙƒØ©
  function updateGridBg(){ WS.classList.toggle('grid-on', snapToggle && snapToggle.checked); }
  if(snapToggle){ snapToggle.addEventListener('change', updateGridBg); updateGridBg(); }

  // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø§Øº
  WS.addEventListener('pointerdown', (e)=>{ if(!e.target.closest('.piece')){ if(selected) selected.classList.remove('selected'); selected=null; } }, {passive:false});

  // ØªÙ‡ÙŠØ¦Ø©
  window.addEventListener('resize', setupCanvas);
  setupCanvas();
  const cx = Math.max(0, (WS.clientWidth - 144) / 2);
  const cy = Math.max(0, (WS.clientHeight - 120) / 2);
  createPiece('one', 24, 24);
  createPiece('ten', 80, 24);
  createPiece('hundred', 24, 80);
  createPiece('thousand', Math.round(cx), Math.round(cy));
  syncPenButtons();
  updateCounts();

})();
</script>
</body>
</html>